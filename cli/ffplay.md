# FFplay 常用命令

FFplay 是以 FFmpeg 框架为基础，外加渲染音视频的库 libSDL 来构建的媒体文件播放器。

- [FFplay 常用命令](#ffplay-常用命令)
  - [播放一个音频文件](#播放一个音频文件)
  - [播放一个视频文件](#播放一个视频文件)
    - [从第 30 秒开始播放 10 秒](#从第-30-秒开始播放-10-秒)
    - [循环播放](#循环播放)
    - [播放视频中的第一路音频流](#播放视频中的第一路音频流)
    - [表示播放视频中的第一路视频流](#表示播放视频中的第一路视频流)
  - [播放裸数据](#播放裸数据)
    - [播放 PCM 格式的音频](#播放-pcm-格式的音频)
    - [播放 YUV420P 格式的视频帧](#播放-yuv420p-格式的视频帧)
    - [播放 RGB 的原始数据](#播放-rgb-的原始数据)
  - [音画同步](#音画同步)
    - [指定对齐方式](#指定对齐方式)

## 播放一个音频文件

```shell
ffplay audio.aac
```

这时候会弹出一个窗口，一边播放音频文件，一边将播放声音的语谱图画到该窗口上。针对该窗口的操作如下，点击窗口的任意一个位置，ffplay 会按照点击的位置计算出时间的进度，然后跳到这个时间点上继续播放；按下键盘上的右键会默认快进 10s，左键默认后退 10s，上键默认快进 1min，下键默认后退 1min；按 ESC 键就是退出播放进程；如果按 w 键则将绘制音频的波形图等。

## 播放一个视频文件

```shell
ffplay video.mp4
```

这时候会直接在新弹出的窗口上播放该视频，如果想要同时播放多个文件，那么只需要在多个命令行下同时执行 ffplay 就可以了，按 s 键则可以进入 frame-step 模式，即按 s 键一次就会播放下一帧图像。

### 从第 30 秒开始播放 10 秒

```shell
# 从第 30 秒开始播放 10 秒
ffplay -ss 30 -t 10 long.mp4
```

### 循环播放

```shell
ffplay video.mp4 -loop 10
```

### 播放视频中的第一路音频流

```shell
ffplay video.mkv -ast 1
```

### 表示播放视频中的第一路视频流

```shell
ffplay video.mkv -vst 1
```

## 播放裸数据

### 播放 PCM 格式的音频

```shell
ffplay song.pcm -f s16le -channels 2 -ar 4
```

格式（-f）、声道数（-channels）、采样率（-ar）必须设置正确。其中任何一项参数设置不正确，都不会得到正常的播放结果。

WAV 格式的文件称为无压缩的格式，其实就是在 PCM 的头部添加 44 个字节，用于标识这个 PCM 的采样表示格式、声道数、采样率等信息，对于 WAV 格式音频文件，ffplay 可以直接播放，但是若让 ffplay 播放 PCM 裸数据的话，只要为其提供上述三个主要的信息，那么它就可以正确地播放了。

### 播放 YUV420P 格式的视频帧

```shell
ffplay -f rawvideo -pixel_format yuv420p -s 480*480 texture.yuv
```

格式（-f rawvideo代表原始格式）、表示格式（-pixel_format yuv420p）、宽高（-s 480*480）。

### 播放 RGB 的原始数据

```shell
ffplay -f rawvideo -pixel_format rgb24 -s 480*480 texture.rgb
```

## 音画同步

ffplay 中音画同步的实现方式其实有三种：以音频为主时间轴作为同步源；以视频为主时间轴作为同步源；以外部时钟为主时间轴作为同步源。在 ffplay 中默认的对齐方式也是以音频为基准进行对齐的。

播放器接收到的视频帧或者音频帧，内部都会有时间戳（PTS 时钟）来标识它实际应该在什么时刻进行展示。实际的对齐策略如下：比较视频当前的播放时间和音频当前的播放时间，如果视频播放过快，则通过加大延迟或者重复播放来降低视频播放速度；如果视频播放慢了，则通过减小延迟或者丢帧来追赶音频播放的时间点。关键就在于音视频时间的比较以及延迟的计算，在比较的过程中会设置一个阈值（Threshold），若超过预设的阈值就应该做调整（丢帧渲染或者重复渲染）。

### 指定对齐方式

```shell
# 以音频为主时间轴
ffplay 32037.mp4 -sync audio

# 以视频为主时间轴
ffplay 32037.mp4 -sync video

# 以外部时钟为主时间轴
ffplay 32037.mp4 -sync ext
```
